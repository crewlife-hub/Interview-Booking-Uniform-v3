<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interview Booking</title>
  <?!= include_('Styles'); ?>
</head>
<body>
  <div class="header">
    <h1>üîê Interview Booking</h1>
    <div class="user-info">Select your details to receive a one-time login code</div>
  </div>

  <div class="container">
    <div class="card" style="max-width:600px;margin:40px auto;padding:20px;">
      <h2>Enter your details</h2>
      <p class="text-muted">Select your brand and position, then enter your email to receive an OTP.</p>

      <div style="margin-top:16px;">
        <label for="brand">Brand</label>
        <select id="brand" class="form-control" onchange="populateTextForEmail()">
          <? for (var i = 0; i < brands.length; i++) { ?>
            <option value="<?= brands[i] ?>"><?= brands[i] ?></option>
          <? } ?>
        </select>
      </div>

      <div style="margin-top:12px;">
        <label for="textForEmail">Text For Email / Position</label>
        <select id="textForEmail" class="form-control" disabled>
          <option value="">Loading‚Ä¶</option>
        </select>
      </div>

      <div style="margin-top:12px;">
        <label for="email">Email</label>
        <input id="email" type="email" class="form-control" placeholder="you@example.com" />
      </div>

      <div style="text-align:center;margin-top:18px;">
        <button id="startBtn" class="btn btn-primary" onclick="startOtp()">üìß Send OTP</button>
      </div>

      <div id="msg" style="margin-top:16px;display:none"></div>
    </div>
  </div>

  <div class="version-tag">v<?= version ?></div>

  <script>
    function populateTextForEmail() {
      var brand = document.getElementById('brand').value;
      var sel   = document.getElementById('textForEmail');
      sel.innerHTML = '<option value="">Loading‚Ä¶</option>';
      sel.disabled  = true;

      google.script.run
        .withSuccessHandler(function(options) {
          sel.innerHTML = '';
          sel.disabled  = false;
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.text  = (options && options.length) ? '-- Select position --' : '-- No positions found --';
          sel.appendChild(placeholder);
          if (options && options.length) {
            options.forEach(function(val) {
              var opt   = document.createElement('option');
              opt.value = val;
              opt.text  = val;
              sel.appendChild(opt);
            });
          }
        })
        .withFailureHandler(function(err) {
          sel.innerHTML = '<option value="">Error loading positions</option>';
          sel.disabled  = false;
          console.error('populateTextForEmail error:', err);
        })
        .getTextForEmailOptionsForBrandApi(brand);
    }

    function startOtp() {
      var btn          = document.getElementById('startBtn');
      var brand        = document.getElementById('brand').value.trim();
      var textForEmail = document.getElementById('textForEmail').value.trim();
      var email        = document.getElementById('email').value.trim();

      showMsg('', '');

      if (!brand) { showMsg('danger', 'Please select a brand.'); return; }
      if (!textForEmail) { showMsg('danger', 'Please select a position (Text For Email).'); return; }
      if (!email) { showMsg('danger', 'Please enter your email address.'); return; }

      btn.disabled    = true;
      btn.textContent = 'Sending‚Ä¶';

      google.script.run
        .withSuccessHandler(function(res) {
          btn.disabled    = false;
          btn.textContent = 'üìß Send OTP';
          if (res && res.ok) {
            window.location.href = res.verifyUrl;
          } else {
            showMsg('danger', (res && res.error) || 'Failed to start OTP flow.');
          }
        })
        .withFailureHandler(function(err) {
          btn.disabled    = false;
          btn.textContent = 'üìß Send OTP';
          showMsg('danger', (err && err.message) || 'An unexpected error occurred.');
        })
        .startOtpByTextForEmail({ brand: brand, email: email, textForEmail: textForEmail });
    }

    function showMsg(type, text) {
      var msg = document.getElementById('msg');
      if (!type && !text) { msg.style.display = 'none'; return; }
      msg.style.display = 'block';
      msg.className     = 'alert alert-' + type;
      msg.textContent   = text;
    }

    // Populate on page load
    (function() { try { populateTextForEmail(); } catch(e) {} })();
  </script>
</body>
</html>