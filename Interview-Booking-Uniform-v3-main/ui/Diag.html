<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>System Diagnostics</title>
  <?!= include('SharedStyles') ?>
  <style>
    body {
      background: #f5f7fa;
      display: block;
      padding: 20px;
    }
    
    .diag-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .diag-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .diag-header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
    }
    
    .diag-header p {
      margin: 0;
      opacity: 0.9;
    }
    
    .diag-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-card .label {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }
    
    .stat-card .value.success { color: #27ae60; }
    .stat-card .value.warning { color: #f39c12; }
    .stat-card .value.error { color: #e74c3c; }
    
    .table-scroll {
      overflow-x: auto;
    }
    
    .log-message {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .refresh-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }
    
    .refresh-btn:hover {
      transform: scale(1.1);
    }
    
    .refresh-btn svg {
      width: 24px;
      height: 24px;
    }
  </style>
</head>
<body>
  <div class="diag-container">
    <div class="diag-header">
      <h1>ðŸ”§ System Diagnostics</h1>
      <p>Interview Booking Uniform System v3</p>
    </div>
    
    <!-- Schema Status -->
    <div class="diag-section">
      <h2>Schema Status</h2>
      <div class="table-scroll">
        <table class="diag-table">
          <thead>
            <tr>
              <th>Tab</th>
              <th>Status</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            <? for (var i = 0; i < schemaStatus.length; i++) { ?>
            <tr>
              <td><?= schemaStatus[i].tab ?></td>
              <td>
                <span class="status-badge <?= schemaStatus[i].status === 'OK' ? 'success' : (schemaStatus[i].status === 'FIXED' ? 'warning' : 'error') ?>">
                  <?= schemaStatus[i].status ?>
                </span>
              </td>
              <td><?= schemaStatus[i].message ?></td>
            </tr>
            <? } ?>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Brand Configurations -->
    <div class="diag-section">
      <h2>Brand Configurations</h2>
      <div class="table-scroll">
        <table class="diag-table">
          <thead>
            <tr>
              <th>Brand</th>
              <th>Active</th>
              <th>Sheet ID</th>
              <th>Trigger Value</th>
              <th>Sent Value</th>
              <th>Default Booking URL</th>
            </tr>
          </thead>
          <tbody>
            <? if (brandConfigs.length === 0) { ?>
            <tr>
              <td colspan="6" style="text-align: center; color: #666;">No brands configured</td>
            </tr>
            <? } ?>
            <? for (var i = 0; i < brandConfigs.length; i++) { ?>
            <tr>
              <td><strong><?= brandConfigs[i].Brand || 'â€”' ?></strong></td>
              <td>
                <span class="status-badge <?= String(brandConfigs[i].Active).toUpperCase() === 'TRUE' ? 'success' : 'warning' ?>">
                  <?= brandConfigs[i].Active || 'FALSE' ?>
                </span>
              </td>
              <td style="font-family: monospace; font-size: 12px;"><?= brandConfigs[i].SmartsheetSheetId || 'â€”' ?></td>
              <td><?= brandConfigs[i].InviteTriggerValue || 'Sideways' ?></td>
              <td><?= brandConfigs[i].InviteSentValue || 'ðŸ””Sent' ?></td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                <?= brandConfigs[i].DefaultBookingUrl || 'â€”' ?>
              </td>
            </tr>
            <? } ?>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Dispatcher Controls -->
    <div class="diag-section">
      <h2>Dispatcher Controls</h2>
      <p style="color: #666; margin-bottom: 16px;">Run the invite dispatcher to process Smartsheet rows with trigger value.</p>
      
      <div class="btn-group" style="max-width: 400px;">
        <button class="btn btn-secondary" onclick="runDispatcher(true)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          Dry Run
        </button>
        <button class="btn btn-primary" onclick="runDispatcher(false)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Run Live
        </button>
      </div>
      
      <div id="dispatcherResult" style="margin-top: 16px; display: none;"></div>
    </div>
    
    <!-- Recent Logs -->
    <div class="diag-section">
      <h2>Recent Logs (Last 50)</h2>
      <div class="table-scroll">
        <table class="diag-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Trace ID</th>
              <th>Brand</th>
              <th>Event</th>
              <th>Result</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            <? if (recentLogs.length === 0) { ?>
            <tr>
              <td colspan="6" style="text-align: center; color: #666;">No logs yet</td>
            </tr>
            <? } ?>
            <? for (var i = 0; i < recentLogs.length; i++) { ?>
            <tr>
              <td style="font-size: 12px; white-space: nowrap;"><?= recentLogs[i].Timestamp || 'â€”' ?></td>
              <td style="font-family: monospace; font-size: 12px;"><?= recentLogs[i].TraceId || 'â€”' ?></td>
              <td><?= recentLogs[i].Brand || 'â€”' ?></td>
              <td style="font-size: 12px;"><?= recentLogs[i].Event || 'â€”' ?></td>
              <td>
                <span class="status-badge <?= recentLogs[i].Result === 'SUCCESS' ? 'success' : (recentLogs[i].Result === 'ERROR' ? 'error' : (recentLogs[i].Result === 'FAILURE' ? 'warning' : 'info')) ?>">
                  <?= recentLogs[i].Result || 'INFO' ?>
                </span>
              </td>
              <td class="log-message" title="<?= recentLogs[i].Message ?>"><?= recentLogs[i].Message || 'â€”' ?></td>
            </tr>
            <? } ?>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <button class="refresh-btn" onclick="location.reload()" title="Refresh">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="23 4 23 10 17 10"/>
      <polyline points="1 20 1 14 7 14"/>
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
    </svg>
  </button>
  
  <?!= include('SharedScripts') ?>
  
  <script>
    function runDispatcher(dryRun) {
      const resultDiv = document.getElementById('dispatcherResult');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<div class="alert alert-info">Running dispatcher...</div>';
      
      const params = new URLSearchParams();
      params.append('action', 'run_dispatcher');
      params.append('dryRun', dryRun);
      
      fetch(window.location.href.split('?')[0], {
        method: 'POST',
        body: params,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <strong>${dryRun ? 'Dry Run' : 'Live Run'} Complete</strong><br>
              Trace ID: ${data.traceId}<br>
              Brands processed: ${data.brands.length}<br>
              Total sent: ${data.totalSent}<br>
              Total errors: ${data.totalErrors}
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-error">
              <strong>Error:</strong> ${data.error || 'Unknown error'}
            </div>
          `;
        }
      })
      .catch(error => {
        resultDiv.innerHTML = `
          <div class="alert alert-error">
            <strong>Request failed:</strong> ${error.message}
          </div>
        `;
      });
    }
  </script>
</body>
</html>
