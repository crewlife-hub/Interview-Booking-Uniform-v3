# CrewLife Interview Bookings ‚Äì Restructure Plan

## Executive Summary

Replace Google Forms OTP flow with a unified Apps Script Web App while keeping the existing Smartsheet-triggered email journey intact. This eliminates manual Form updates when adding new jobs or CL codes.

---

## 1. Current vs. Target Architecture

### Current Flow (Google Forms)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Recruiter   ‚îÇ    ‚îÇ Smartsheet  ‚îÇ    ‚îÇ Candidate   ‚îÇ    ‚îÇ Google Form ‚îÇ
‚îÇ sets        ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ sends email ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ clicks link ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ OTP Request ‚îÇ
‚îÇ "Sideways"  ‚îÇ    ‚îÇ with CTA    ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ Form        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
                   ‚îÇ Booking URL ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÇ OTP Verify  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ (Calendar)  ‚îÇ    ‚îÇ Form        ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Problems:**
- Google Forms require manual dropdown updates for each new Job/CL code
- No signature protection on URLs (anyone can guess/tamper)
- OTP logic scattered across Form + Apps Script
- CL code ‚Üí booking URL mapping buried in Form/script

### Target Flow (Web App)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Recruiter   ‚îÇ    ‚îÇ Smartsheet Automation                           ‚îÇ
‚îÇ sets        ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ 1. Change column to "üîîSent"                    ‚îÇ
‚îÇ "Sideways"  ‚îÇ    ‚îÇ 2. Send email with SIGNED link to Web App       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Apps Script Web App                                                 ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 1. Verify HMAC   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ 2. Validate vs   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ 3. OTP Entry  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ    signature     ‚îÇ    ‚îÇ    Smartsheet    ‚îÇ    ‚îÇ    Page       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                          ‚îÇ         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚ñº         ‚îÇ
‚îÇ  ‚îÇ 5. Redirect to   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÇ 4. OTP Verify    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ  ‚îÇ    Booking URL   ‚îÇ    ‚îÇ    Page (POST)   ‚îÇ                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Benefits:**
- CL codes/jobs managed in Config Sheet (no Form edits)
- HMAC signatures prevent URL tampering
- Single codebase for all brands
- Scanner-safe (GET shows page, POST confirms)
- Full audit logging

---

## 2. URL Signature (HMAC) Design

### Why HMAC?
Smartsheet emails are sent to candidates with a link. Without a signature, anyone could craft a URL with any email/job combination. HMAC ensures only links generated by Smartsheet automation are valid.

### Signature Algorithm

```
HMAC_SECRET = (stored in Script Properties, 32+ chars)

dataToSign = brand + "|" + email + "|" + textForEmail + "|" + timestamp
signature  = HMAC-SHA256(HMAC_SECRET, dataToSign).substring(0, 16)
```

### URL Format

```
https://script.google.com/.../exec
  ?brand=ROYAL
  &e=candidate@email.com
  &t=Shop%20Attendant%20-%20CL200
  &ts=1737500000
  &sig=a1b2c3d4e5f67890
```

| Param | Description |
|-------|-------------|
| `brand` | ROYAL, COSTA, SEACHEFS, CPD |
| `e` | Candidate email (URL-encoded) |
| `t` | Text For Email value (URL-encoded) |
| `ts` | Unix timestamp (seconds) when link was generated |
| `sig` | First 16 chars of HMAC-SHA256 hex |

### Validation Rules

1. **Signature mismatch** ‚Üí Reject with "Invalid link"
2. **Timestamp > 7 days old** ‚Üí Reject with "Link expired"
3. **Email + Text For Email not in Smartsheet** ‚Üí Reject with "Candidate not found"

### Apps Script Implementation (Pseudocode)

```javascript
function validateSignedUrl_(params) {
  var brand = params.brand;
  var email = params.e;
  var textForEmail = params.t;
  var timestamp = Number(params.ts);
  var providedSig = params.sig;

  // 1. Check timestamp freshness (7 days = 604800 seconds)
  var now = Math.floor(Date.now() / 1000);
  if (now - timestamp > 604800) {
    return { ok: false, error: 'Link expired' };
  }

  // 2. Recompute signature
  var secret = getHmacSecret_();
  var data = brand + '|' + email + '|' + textForEmail + '|' + timestamp;
  var expectedSig = computeHmac_(secret, data).substring(0, 16);

  if (providedSig !== expectedSig) {
    return { ok: false, error: 'Invalid link signature' };
  }

  // 3. Validate against Smartsheet
  var candidate = searchCandidateInSmartsheet_(brand, email, textForEmail);
  if (!candidate.found || !candidate.exactMatch) {
    return { ok: false, error: 'Candidate not found in system' };
  }

  return { ok: true, candidate: candidate };
}
```

---

## 3. Web App Pages (Replacing Google Forms)

### Page 1: OTP Request (`?page=otp&...signed params...`)

**When:** Candidate clicks link in Smartsheet email

**Behavior:**
1. Validate HMAC signature
2. Validate Email + Text For Email against Smartsheet
3. If valid: Show branded page with "Send OTP" button
4. If invalid: Show error page

**UI Elements:**
- Brand logo/header (match current email style)
- "Hi [First Name]!" greeting
- Position: [Text For Email]
- [Send OTP to my email] button
- Footer: "Crew Life at Sea Schedulers"

**On Submit (POST):**
1. Generate 6-digit OTP
2. Store in TOKENS sheet: email, otp, brand, textForEmail, expiry (10 min), status=PENDING
3. Send OTP email (same style as current screenshot)
4. Show confirmation: "Check your inbox for your OTP"

### Page 2: OTP Verification (`?page=verify&...signed params...`)

**When:** Candidate receives OTP email and clicks "Enter Your Passcode" button (or returns to page)

**Behavior:**
1. Show OTP entry form (6-digit input)
2. On submit (POST): validate OTP
3. If valid: Mark token USED, redirect to booking URL
4. If invalid: Show error, allow retry (max 3 attempts)

**UI Elements:**
- Brand logo/header
- "Enter your 6-digit passcode"
- [______] input field
- [Verify] button
- "Didn't receive it? [Resend OTP]"
- "Link expires in X minutes"

### Page 3: Booking Redirect

**When:** OTP verified successfully

**Behavior:**
1. Resolve CL code from Text For Email
2. Look up booking URL from CL_CODES sheet
3. Show scanner-safe confirmation page (GET)
4. On button click (POST): redirect to booking URL

**UI Elements:**
- "‚úÖ Verified!"
- "You're booking with: [Recruiter Name]"
- "Position: [Job Title]"
- [Book Your Interview] button (triggers POST)

---

## 4. Smartsheet Email Template

### Email 1: Initial Invite (Sent by Smartsheet Automation)

**Subject:** `Schedule Your Interview ‚Äì {Position}`

**Body (HTML):**
```html
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <!-- Header Banner -->
  <div style="background: linear-gradient(135deg, #1a237e, #0d47a1); padding: 20px; text-align: center;">
    <img src="[LOGO_URL]" alt="Crew Life at Sea" style="height: 60px;">
    <h2 style="color: white; margin: 10px 0;">üîí SECURE YOUR INTERVIEW BOOKING</h2>
  </div>

  <div style="padding: 30px; background: #fff;">
    <p style="font-size: 24px; text-align: center;">
      üéâ <strong>Congratulations, {First Name}!</strong>
    </p>
    
    <p>You've reached the interview stage for the position of <strong>{Position}</strong>.</p>
    
    <p>Please review the details below and follow the instructions carefully to secure your slot.</p>

    <!-- CTA Box -->
    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; text-align: center; margin: 20px 0;">
      <p style="color: #856404; font-size: 16px; margin: 0;">
        ‚ö†Ô∏è <strong>MUST SELECT THE OPTION BELOW</strong> ‚ö†Ô∏è
      </p>
      <p style="color: #856404; margin: 5px 0;">Make sure to select this when booking your interview !!!</p>
    </div>

    <!-- Text For Email Badge -->
    <div style="background: #0d6efd; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0;">
      <span style="color: white; font-size: 20px;">üìå <strong>{Text For Email}</strong> üìå</span>
    </div>

    <p><strong>Please note:</strong> This link is valid for <strong>7 days</strong> and can only be used once.</p>

    <p><strong>Make sure you're ready:</strong></p>
    <ul style="color: #28a745;">
      <li>‚úÖ Be online at least 10 minutes early</li>
      <li>‚úÖ Test your connection and camera (if online)</li>
      <li>‚úÖ Dress professionally</li>
      <li>‚úÖ Have your CV and any required documents ready</li>
    </ul>

    <!-- MAIN CTA BUTTON -->
    <div style="text-align: center; margin: 30px 0;">
      <a href="{SIGNED_BOOKING_URL}" 
         style="background: #0d6efd; color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold;">
        Book Your Interview
      </a>
    </div>

    <hr style="border: 1px solid #eee; margin: 30px 0;">
    
    <p style="text-align: center; color: #666;">
      Best regards,<br>
      <strong>Crew Life at Sea Recruitment Team</strong>
    </p>
  </div>
</div>
```

### Generating the Signed URL in Smartsheet

**Option A: Smartsheet Formula (Limited)**
Smartsheet formulas cannot compute HMAC. You must use a webhook or external script.

**Option B: Apps Script URL Generator (Recommended)**

Create an endpoint that Smartsheet automation calls to get the signed URL:

```
POST /exec?action=generateLink
Body: { brand: "ROYAL", email: "...", textForEmail: "..." }
Response: { url: "https://...?brand=ROYAL&e=...&t=...&ts=...&sig=..." }
```

Smartsheet automation workflow:
1. Trigger: Column "SEND Invite" changes to "Sideways"
2. Action 1: Call Apps Script webhook to get signed URL
3. Action 2: Send email with the returned URL
4. Action 3: Change column to "üîîSent"

**Option C: Pre-signed URL in Smartsheet Column**

Add a column `Booking Link` with formula that calls a bridge URL:

```
=IF([SEND Invite]@row = "Sideways", 
    "https://script.google.com/.../exec?action=redirect&row=" + [Row ID]@row,
    "")
```

The bridge URL fetches row data, generates signature on-the-fly, and redirects.

---

## 5. OTP Email Template

**Subject:** `Your Interview Booking Passcode ‚Äì {Brand}`

**Body (HTML):**
```html
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <div style="background: linear-gradient(135deg, #1a237e, #0d47a1); padding: 20px; text-align: center;">
    <img src="[LOGO_URL]" alt="Crew Life at Sea">
    <h2 style="color: white;">üîí SECURE YOUR INTERVIEW BOOKING</h2>
  </div>

  <div style="padding: 30px; background: #fff;">
    <p>Hello <strong>{First Name}</strong>,</p>
    
    <p>Thanks for your interest in <strong>Crew Life at Sea!</strong></p>
    <p>Please use the secure One-Time Passcode (OTP) below to verify your email and unlock the booking page:</p>

    <!-- OTP Box -->
    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 30px; text-align: center; margin: 20px 0;">
      <span style="font-size: 48px; font-weight: bold; color: #0d47a1; letter-spacing: 8px;">{OTP}</span>
      <p style="margin: 10px 0 0 0; color: #666;">Expires in <strong>10 minutes</strong></p>
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <a href="{VERIFY_URL}" 
         style="background: #0d6efd; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px;">
        Enter Your Passcode
      </a>
    </div>

    <hr style="border: 1px solid #eee; margin: 30px 0;">

    <!-- Fraud Warning -->
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin: 20px 0;">
      <p style="color: #721c24; margin: 0;">
        üö® <strong>FRAUD ALERT ‚Äì ZERO TOLERANCE POLICY</strong>
      </p>
      <ul style="color: #721c24; margin: 10px 0;">
        <li>Permanent blacklisting from all cruise lines and partners</li>
        <li>Application suspension without notice</li>
        <li>Reporting to SAPS, Hawks, Cybercrime Unit</li>
        <li>Legal prosecution under South African & international law</li>
      </ul>
      <p style="color: #721c24; margin: 0;">
        ‚ö†Ô∏è <strong>Fake documents or fraud = permanent ban & legal action.</strong>
      </p>
    </div>

    <p style="color: #666; font-size: 12px;">
      Do not share this link or OTP. All usage is monitored.<br>
      We're here to help genuine candidates ‚Äî not fraudsters.
    </p>

    <p style="text-align: center;">
      Best regards,<br>
      <strong>Crew Life at Sea Team</strong>
    </p>
  </div>
</div>
```

---

## 6. Config Sheet Structure

**Sheet ID:** `1qM3ZEdBsvbEofDH8DayRWcRa4bUcrKQIv8kzKSYZ1AM`

### Tab: CL_CODES
| Brand | CL Code | Recruiter Name | Recruiter Email | Booking Schedule URL | Active | Last Updated |
|-------|---------|----------------|-----------------|---------------------|--------|--------------|
| ROYAL | CL200 | Waiters Recruiter | recruiter@... | https://calendar... | TRUE | 2026-01-21 |
| ROYAL | CL201 | Kitchen Recruiter | recruiter@... | https://calendar... | TRUE | 2026-01-21 |

### Tab: JOBS
| Brand | Job Title | Default CL Code | Department | Active |
|-------|-----------|-----------------|------------|--------|
| ROYAL | Shop Attendant | CL200 | Retail | TRUE |
| ROYAL | 2ND BUTCHER | CL201 | Culinary | TRUE |

### Tab: TOKENS
| Token | Email | OTP | Brand | Text For Email | Status | Expiry | Created At | Used At | Attempts |
|-------|-------|-----|-------|----------------|--------|--------|------------|---------|----------|
| uuid | cand@... | 384302 | ROYAL | Shop Attendant - CL200 | PENDING | ... | ... | | 0 |

### Tab: LOGS
| Timestamp | Trace ID | Brand | Email (Masked) | Event | Details | Actor |

### Tab: BRAND_CONFIG
| Brand | Smartsheet ID | Token Expiry Hours | Active | Admin Emails |
|-------|---------------|-------------------|--------|--------------|
| ROYAL | xRccjf2Fxccx... | 48 | TRUE | admin@... |

---

## 7. Scanner-Safe Design

### Problem
Email security scanners (Microsoft ATP, Google Safe Browsing, Barracuda) pre-fetch URLs to check for malware. This can "burn" single-use tokens before the candidate clicks.

### Solution
Use a **two-step confirmation**:

1. **GET request (scanner or candidate):** Returns HTML page with "Confirm" button. Does NOT mark token as used.
2. **POST request (candidate clicks button):** Marks token as used and redirects to booking URL.

Scanners only issue GET requests; they don't submit forms.

### Implementation

```javascript
// GET: Show confirmation page
function doGet(e) {
  // ... validate signature, validate against Smartsheet ...
  // Show page with form that POSTs
  return HtmlService.createTemplateFromFile('Confirm').evaluate();
}

// POST: Actually consume the token
function doPost(e) {
  // ... validate, mark USED, redirect to booking URL
}
```

**Confirm.html:**
```html
<form method="POST" action="<?= webAppUrl ?>">
  <input type="hidden" name="token" value="<?= token ?>">
  <input type="hidden" name="brand" value="<?= brand ?>">
  <button type="submit">Book Your Interview</button>
</form>
```

---

## 8. Recruiter Workflow (Unchanged)

1. Recruiter opens Smartsheet
2. Finds candidate row
3. Sets "SEND Invite" column to "Sideways"
4. Smartsheet automation runs:
   - Calls Apps Script to generate signed URL
   - Sends email with the URL
   - Changes column to "üîîSent"
5. Recruiter sees "üîîSent" and knows email was dispatched

**No change to recruiter behavior. Config Sheet manages CL codes/URLs.**

---

## 9. Migration Plan

### Phase 1: Parallel Build (Week 1)
- [ ] Build new Web App pages (OTP Request, OTP Verify, Confirm)
- [ ] Implement HMAC signature generation/validation
- [ ] Create email templates (HTML)
- [ ] Test with dummy Smartsheet data

### Phase 2: Config Sheet Setup (Week 1)
- [ ] Populate CL_CODES tab with all current CL codes per brand
- [ ] Populate JOBS tab with job title ‚Üí CL code mappings
- [ ] Add HMAC_SECRET to Script Properties

### Phase 3: Smartsheet Integration (Week 2)
- [ ] Create Smartsheet webhook/automation to call Apps Script for signed URLs
- [ ] Update Smartsheet email template to use new URL format
- [ ] Test with one brand (ROYAL)

### Phase 4: Pilot (Week 2-3)
- [ ] Run ROYAL brand on new system for 1 week
- [ ] Keep old Google Forms live for COSTA, SEACHEFS, CPD
- [ ] Monitor LOGS tab for errors
- [ ] Collect recruiter feedback

### Phase 5: Full Rollout (Week 4)
- [ ] Migrate COSTA, SEACHEFS, CPD to new system
- [ ] Disable old Google Forms
- [ ] Archive old Forms (don't delete yet)
- [ ] Monitor for 2 weeks

### Phase 6: Cleanup (Week 6)
- [ ] Delete old Google Forms
- [ ] Remove old Apps Script code
- [ ] Document final architecture

---

## 10. Script Properties Required

| Property | Description | Example |
|----------|-------------|---------|
| `HMAC_SECRET` | 32+ char secret for URL signing | `a7b9c2d4e6f8...` |
| `CONFIG_SHEET_ID` | Config Google Sheet ID | `1qM3ZEdBsvbEo...` |
| `SMARTSHEET_API_TOKEN` | Smartsheet API token | `Bearer xxx` |
| `SMARTSHEET_ID_ROYAL` | ROYAL Smartsheet ID | `xRccjf2Fxccx...` |
| `SMARTSHEET_ID_COSTA` | COSTA Smartsheet ID | `...` |
| `SMARTSHEET_ID_SEACHEFS` | SEACHEFS Smartsheet ID | `...` |
| `SMARTSHEET_ID_CPD` | CPD Smartsheet ID | `...` |
| `OTP_EXPIRY_MINUTES` | OTP validity (default 10) | `10` |
| `LINK_EXPIRY_DAYS` | Signed link validity (default 7) | `7` |

---

## 11. Security Checklist

- [ ] HMAC secret is 32+ characters, stored in Script Properties (not in code)
- [ ] All URLs are validated before any database lookup
- [ ] OTP has max 3 attempts before lockout
- [ ] Token/OTP expiry enforced server-side
- [ ] Email masking in all logs
- [ ] Smartsheet validation happens AFTER signature check (to prevent enumeration)
- [ ] Rate limiting on OTP send (max 3 per email per hour)
- [ ] Admin console restricted to WORKSPACE_DOMAIN or allowlist

---

## 12. Files to Create/Modify

| File | Purpose |
|------|---------|
| `src/HmacService.gs` | HMAC generation, validation, URL builder |
| `src/OtpService.gs` | OTP generation, storage, validation |
| `src/OtpController.gs` | Page routing for OTP request/verify |
| `src/OtpRequest.html` | OTP request page UI |
| `src/OtpVerify.html` | OTP entry page UI |
| `src/OtpEmail.html` | OTP email template |
| `src/InviteEmail.html` | Smartsheet email template (for reference) |
| `src/Router.gs` | Update to handle new pages |
| `src/Config.gs` | Add new properties |

---

## 13. Smartsheet Automation Setup

### Trigger
- Column: "SEND Invite"
- Condition: Changes to "Sideways"

### Actions
1. **Run Webhook** (to Apps Script)
   - URL: `https://script.google.com/.../exec?action=generateSignedUrl`
   - Method: POST
   - Body: `{ "brand": "{{Brand}}", "email": "{{Email}}", "textForEmail": "{{Text For Email}}" }`
   - Store response in hidden column `_SignedUrl`

2. **Send Email**
   - To: `{{Email}}`
   - Subject: `Schedule Your Interview ‚Äì {{Text For Email}}`
   - Body: Use template with `{{_SignedUrl}}` inserted

3. **Update Column**
   - Set "SEND Invite" to "üîîSent"

---

## 14. Summary

| Component | Old System | New System |
|-----------|------------|------------|
| Trigger | Smartsheet automation | Smartsheet automation (unchanged) |
| OTP Request | Google Form | Apps Script Web App |
| OTP Verify | Google Form | Apps Script Web App |
| CL Code Config | Form dropdown (manual) | Config Sheet (CL_CODES tab) |
| URL Security | None | HMAC signature + expiry |
| Candidate Validation | None | Email + Text For Email vs Smartsheet |
| Scanner Protection | None | GET/POST split |
| Logging | Scattered | Unified LOGS tab |

**Next Step:** Approve this plan, then I'll implement the code changes.
